---
title: "5th Reweighting based on Ridership"
author: "Zehui Yin"
format: html
---

```{r}
library(cancensus)
library(tidyverse)
library(sf)
library(arrow)
library(mapview)
```

# Read data

```{r}
catchment_socdem <- st_read("./Data/catchment_areas_no_overlap_with_socdem.gpkg")
catchment_socdem <- as.data.frame(catchment_socdem)
ridership <- read_parquet("./Data/station_with_ridership.parquet")
```

```{r}
catchment <- merge(catchment_socdem,
                   ridership,
                   by = "station_id")
```

# All riders

- Female

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_female*all_trips) |>
  pluck("cross") |> sum()/sum(catchment$all_trips)
```

- Other Gender

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_rest_gender*all_trips) |>
  pluck("cross") |> sum()/sum(catchment$all_trips)
```

- Indigenous

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_indigenous*all_trips) |>
  pluck("cross") |> sum()/sum(catchment$all_trips)
```

- Non-Indigenous

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_non_indigenous*all_trips) |>
  pluck("cross") |> sum()/sum(catchment$all_trips)
```

- White

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_white*all_trips) |>
  pluck("cross") |> sum()/sum(catchment$all_trips)
```

- Chinese

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_chinese*all_trips) |>
  pluck("cross") |> sum()/sum(catchment$all_trips)
```

- Black

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_black*all_trips) |>
  pluck("cross") |> sum()/sum(catchment$all_trips)
```

- Latino

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_latino*all_trips) |>
  pluck("cross") |> sum()/sum(catchment$all_trips)
```

- Other Ethnicity

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_rest_ethnicity*all_trips) |>
  pluck("cross") |> sum()/sum(catchment$all_trips)
```

- Income below 40k

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_income_blw40k*all_trips) |>
  pluck("cross") |> sum(na.rm = T)/sum(catchment$all_trips, na.rm = T)
```

- Income above 100k

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_income_abv100k*all_trips) |>
  pluck("cross") |> sum(na.rm = T)/sum(catchment$all_trips, na.rm = T)
```

- Other Income

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_rest_income*all_trips) |>
  pluck("cross") |> sum(na.rm = T)/sum(catchment$all_trips, na.rm = T)
```

# Casual riders

- Female

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_female*casual) |>
  pluck("cross") |> sum()/sum(catchment$casual)
```

- Other Gender

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_rest_gender*casual) |>
  pluck("cross") |> sum()/sum(catchment$casual)
```

- Indigenous

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_indigenous*casual) |>
  pluck("cross") |> sum()/sum(catchment$casual)
```

- Non-Indigenous

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_non_indigenous*casual) |>
  pluck("cross") |> sum()/sum(catchment$casual)
```

- White

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_white*casual) |>
  pluck("cross") |> sum()/sum(catchment$casual)
```

- Chinese

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_chinese*casual) |>
  pluck("cross") |> sum()/sum(catchment$casual)
```

- Black

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_black*casual) |>
  pluck("cross") |> sum()/sum(catchment$casual)
```

- Latino

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_latino*casual) |>
  pluck("cross") |> sum()/sum(catchment$casual)
```

- Other Ethnicity

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_rest_ethnicity*casual) |>
  pluck("cross") |> sum()/sum(catchment$casual)
```

- Income below 40k

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_income_blw40k*casual) |>
  pluck("cross") |> sum(na.rm = T)/sum(catchment$casual, na.rm = T)
```

- Income above 100k

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_income_abv100k*casual) |>
  pluck("cross") |> sum(na.rm = T)/sum(catchment$casual, na.rm = T)
```

- Other Income

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_rest_income*casual) |>
  pluck("cross") |> sum(na.rm = T)/sum(catchment$casual, na.rm = T)
```

# Annual riders

- Female

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_female*annual) |>
  pluck("cross") |> sum()/sum(catchment$annual)
```

- Other Gender

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_rest_gender*annual) |>
  pluck("cross") |> sum()/sum(catchment$annual)
```

- Indigenous

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_indigenous*annual) |>
  pluck("cross") |> sum()/sum(catchment$annual)
```

- Non-Indigenous

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_non_indigenous*annual) |>
  pluck("cross") |> sum()/sum(catchment$annual)
```

- White

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_white*annual) |>
  pluck("cross") |> sum()/sum(catchment$annual)
```

- Chinese

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_chinese*annual) |>
  pluck("cross") |> sum()/sum(catchment$annual)
```

- Black

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_black*annual) |>
  pluck("cross") |> sum()/sum(catchment$annual)
```

- Latino

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_latino*annual) |>
  pluck("cross") |> sum()/sum(catchment$annual)
```

- Other Ethnicity

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_rest_ethnicity*annual) |>
  pluck("cross") |> sum()/sum(catchment$annual)
```

- Income below 40k

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_income_blw40k*annual) |>
  pluck("cross") |> sum(na.rm = T)/sum(catchment$annual, na.rm = T)
```

- Income above 100k

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_income_abv100k*annual) |>
  pluck("cross") |> sum(na.rm = T)/sum(catchment$annual, na.rm = T)
```

- Other Income

```{r}
catchment |> 
  rowwise() |>
  mutate(cross = PCT_rest_income*annual) |>
  pluck("cross") |> sum(na.rm = T)/sum(catchment$annual, na.rm = T)
```

# City of Toronto Level

```{r}
options(cancensus.api_key = "your_key_here")
options(cancensus.cache_path = "./Census")

# Returns data and geography as an sf-class data frame
census_data <- get_census(
  # 2021 census
  dataset='CA21',
  # CSD Toronto
  regions=list(CSD="3520005"),
  # Census variables
  vectors=c(
    # gender
    "v_CA21_10","v_CA21_8",
    # population count
    "v_CA21_1",
    # Indigenous identity (Total)
    "v_CA21_4204",
    # Total - Indigenous identity for the population in private households (Total)
    "v_CA21_4201",
    # Not a visible minority (Total)
    "v_CA21_4914",
    # Total - Visible minority for the population in private households (Total)
    "v_CA21_4872",
    # Chinese (Total)
    "v_CA21_4881",
    # Black (Total)
    "v_CA21_4884",
    # Latin American (Total)
    "v_CA21_4893",
    # Under $5,000; $5,000 to $9,999; $10,000 to $14,999; $15,000 to $19,999 ;
    # $20,000 to $24,999; $25,000 to $29,999; $30,000 to $34,999; $35,000 to $39,999
    "v_CA21_924","v_CA21_925","v_CA21_926","v_CA21_927","v_CA21_928","v_CA21_929","v_CA21_930","v_CA21_931",
    # $100,000 and over
    # Household total income groups in 2020 for private households
    "v_CA21_939","v_CA21_923"
  ),
  # at Census Tract level
  level='DA',
  geo_format = 'sf', quiet = TRUE)

mapview(census_data)
```

**Variables**:

- Percentage of female

```{r}
census_data$PCT_female <- census_data$`v_CA21_10: Total - Age`/census_data$`v_CA21_8: Total - Age`*100

census_data |> 
  as.data.frame() |>
  rowwise() |>
  mutate(cross = PCT_female*`v_CA21_1: Population, 2021`) |>
  pluck("cross") |> sum(na.rm = T)/sum(census_data$`v_CA21_1: Population, 2021`, na.rm = T)
```

- Percentage of rest of residents based on gender

```{r}
census_data$PCT_rest_gender <- 100-census_data$PCT_female

census_data |> 
  as.data.frame() |>
  rowwise() |>
  mutate(cross = PCT_rest_gender*`v_CA21_1: Population, 2021`) |>
  pluck("cross") |> sum(na.rm = T)/sum(census_data$`v_CA21_1: Population, 2021`, na.rm = T)
```

- Percentage of indigenous people

```{r}
census_data$PCT_indigenous <- census_data$`v_CA21_4204: Indigenous identity (39)`/census_data$`v_CA21_4201: Total - Indigenous identity for the population in private households`*100

census_data |> 
  as.data.frame() |>
  rowwise() |>
  mutate(cross = PCT_indigenous*`v_CA21_1: Population, 2021`) |>
  pluck("cross") |> sum(na.rm = T)/sum(census_data$`v_CA21_1: Population, 2021`, na.rm = T)
```

- Percentage of indigenous people

```{r}
census_data$PCT_non_indigenous <- 100 - census_data$PCT_indigenous

census_data |> 
  as.data.frame() |>
  rowwise() |>
  mutate(cross = PCT_non_indigenous*`v_CA21_1: Population, 2021`) |>
  pluck("cross") |> sum(na.rm = T)/sum(census_data$`v_CA21_1: Population, 2021`, na.rm = T)
```

- Percentage of not a visible minority (White)

```{r}
census_data$PCT_white <- census_data$`v_CA21_4914: Not a visible minority`/census_data$`v_CA21_4872: Total - Visible minority for the population in private households`*100

census_data |> 
  as.data.frame() |>
  rowwise() |>
  mutate(cross = PCT_white*`v_CA21_1: Population, 2021`) |>
  pluck("cross") |> sum(na.rm = T)/sum(census_data$`v_CA21_1: Population, 2021`, na.rm = T)
```

- Percentage of Chinese

```{r}
census_data$PCT_chinese <- census_data$`v_CA21_4881: Chinese`/census_data$`v_CA21_4872: Total - Visible minority for the population in private households`*100

census_data |> 
  as.data.frame() |>
  rowwise() |>
  mutate(cross = PCT_chinese*`v_CA21_1: Population, 2021`) |>
  pluck("cross") |> sum(na.rm = T)/sum(census_data$`v_CA21_1: Population, 2021`, na.rm = T)
```

- Percentage of Black

```{r}
census_data$PCT_black <- census_data$`v_CA21_4884: Black`/census_data$`v_CA21_4872: Total - Visible minority for the population in private households`*100

census_data |> 
  as.data.frame() |>
  rowwise() |>
  mutate(cross = PCT_black*`v_CA21_1: Population, 2021`) |>
  pluck("cross") |> sum(na.rm = T)/sum(census_data$`v_CA21_1: Population, 2021`, na.rm = T)
```

- Percentage of Latin American

```{r}
census_data$PCT_latino <- census_data$`v_CA21_4893: Latin American`/census_data$`v_CA21_4872: Total - Visible minority for the population in private households`*100

census_data |> 
  as.data.frame() |>
  rowwise() |>
  mutate(cross = PCT_latino*`v_CA21_1: Population, 2021`) |>
  pluck("cross") |> sum(na.rm = T)/sum(census_data$`v_CA21_1: Population, 2021`, na.rm = T)
```

- Percentage of rest of residents based on ethnicity

```{r}
census_data$PCT_rest_ethnicity <- 100 - census_data$PCT_white - 
  census_data$PCT_chinese - census_data$PCT_black -
  census_data$PCT_latino

census_data |> 
  as.data.frame() |>
  rowwise() |>
  mutate(cross = PCT_rest_ethnicity*`v_CA21_1: Population, 2021`) |>
  pluck("cross") |> sum(na.rm = T)/sum(census_data$`v_CA21_1: Population, 2021`, na.rm = T)
```

- Percentage of people's household total income below 40k

```{r}
census_data$PCT_income_blw40k <- (census_data$`v_CA21_924: Under $5,000` +
                                    census_data$`v_CA21_925: $5,000 to $9,999` +
                                    census_data$`v_CA21_926: $10,000 to $14,999` +
                                    census_data$`v_CA21_927: $15,000 to $19,999` +
                                    census_data$`v_CA21_928: $20,000 to $24,999` +
                                    census_data$`v_CA21_929: $25,000 to $29,999` +
                                    census_data$`v_CA21_930: $30,000 to $34,999` +
                                    census_data$`v_CA21_931: $35,000 to $39,999`)/census_data$`v_CA21_923: Number of after-tax income recipients aged 15 years and over in private households in 2019`*100

census_data |> 
  as.data.frame() |>
  rowwise() |>
  mutate(cross = PCT_income_blw40k*`v_CA21_1: Population, 2021`) |>
  pluck("cross") |> sum(na.rm = T)/sum(census_data$`v_CA21_1: Population, 2021`, na.rm = T)
```

- Percentage of people's household total income above 100k

```{r}
census_data$PCT_income_abv100k <- census_data$`v_CA21_939: $100,000 and over`/census_data$`v_CA21_923: Number of after-tax income recipients aged 15 years and over in private households in 2019`*100

census_data |> 
  as.data.frame() |>
  rowwise() |>
  mutate(cross = PCT_income_abv100k*`v_CA21_1: Population, 2021`) |>
  pluck("cross") |> sum(na.rm = T)/sum(census_data$`v_CA21_1: Population, 2021`, na.rm = T)
```

- Percentage of rest of residents based on income

```{r}
census_data$PCT_rest_income <- 100 - census_data$PCT_income_blw40k -
  census_data$PCT_income_abv100k

census_data |> 
  as.data.frame() |>
  rowwise() |>
  mutate(cross = PCT_rest_income*`v_CA21_1: Population, 2021`) |>
  pluck("cross") |> sum(na.rm = T)/sum(census_data$`v_CA21_1: Population, 2021`, na.rm = T)
```
